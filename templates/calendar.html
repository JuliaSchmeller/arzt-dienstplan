{% extends "base.html" %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <button class="nav-button" id="prevMonth">&lt;</button>
        <h2 id="monthDisplay"></h2>
        <button class="nav-button" id="nextMonth">&gt;</button>
        {% if current_user.role == UserRole.PLANNER %}
        <button id="generateSchedule" class="action-button">Dienstplan generieren</button>
        {% endif %}
    </div>
    
    <div class="calendar-grid">
        <div class="calendar-days-header">
            <div>Mo</div>
            <div>Di</div>
            <div>Mi</div>
            <div>Do</div>
            <div>Fr</div>
            <div>Sa</div>
            <div>So</div>
        </div>
        <div id="calendarBody" class="calendar-body">
            <!-- Wird durch JavaScript gef체llt -->
        </div>
    </div>

    <div class="calendar-legend">
        <div class="legend-item">
            <div class="color-box dienst"></div>
            <span>Dienst</span>
        </div>
        <div class="legend-item">
            <div class="color-box rufdienst"></div>
            <span>Rufdienst</span>
        </div>
        <div class="legend-item">
            <div class="color-box visite"></div>
            <span>Visite</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDate = new Date({{ year }}, {{ month }} - 1, 1);
    const duties = {{ duties|tojson|safe }};
    
    function updateCalendar() {
        const monthNames = ["Januar", "Februar", "M채rz", "April", "Mai", "Juni",
                          "Juli", "August", "September", "Oktober", "November", "Dezember"];
        
        document.getElementById('monthDisplay').textContent = 
            `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        
        // Anpassung f체r Montag als ersten Tag der Woche (0 = Montag, 6 = Sonntag)
        let firstDayIndex = firstDay.getDay() - 1;
        if (firstDayIndex === -1) firstDayIndex = 6;
        
        const calendarBody = document.getElementById('calendarBody');
        calendarBody.innerHTML = '';
        
        // Leere Zellen f체r Tage vor dem Monatsbeginn
        for (let i = 0; i < firstDayIndex; i++) {
            calendarBody.innerHTML += '<div class="calendar-day empty"></div>';
        }
        
        // Tage des Monats
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            let dutyHtml = '<div class="day-number">' + day + '</div>';
            if (duties[day]) {
                dutyHtml += '<div class="day-content">';
                // Beachte die korrekten Enum-Werte aus DutyType
                if (duties[day]['dienst']) {
                    dutyHtml += `<div class="duty dienst">D: ${duties[day]['dienst']}</div>`;
                }
                if (duties[day]['rufdienst']) {
                    dutyHtml += `<div class="duty rufdienst">R: ${duties[day]['rufdienst']}</div>`;
                }
                if (duties[day]['visite']) {
                    dutyHtml += `<div class="duty visite">V: ${duties[day]['visite']}</div>`;
                }
                dutyHtml += '</div>';
            }
            dayElement.innerHTML = dutyHtml;
            calendarBody.appendChild(dayElement);
        }
    }
    
    document.getElementById('prevMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        window.location.href = `/calendar?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`;
    });
    
    document.getElementById('nextMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        window.location.href = `/calendar?year=${currentDate.getFullYear()}&month=${currentDate.getMonth() + 1}`;
    });
    
    {% if current_user.role == UserRole.PLANNER %}
    document.getElementById('generateSchedule').addEventListener('click', function() {
        window.location.href = `/generate-schedule/${currentDate.getFullYear()}/${currentDate.getMonth() + 1}`;
    });
    {% endif %}
    
    updateCalendar();
});
</script>
{% endblock %}

{% block styles %}
<style>
.calendar-container {
    max-width: 1000px;
    margin: 20px auto;
    padding: 20px;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.calendar-grid {
    border: 1px solid #ddd;
    border-radius: 5px;
}

.calendar-days-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #f5f5f5;
    padding: 10px;
    font-weight: bold;
    text-align: center;
}

.calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.calendar-day {
    border: 1px solid #eee;
    min-height: 100px;
    padding: 5px;
}

.day-number {
    font-weight: bold;
    margin-bottom: 5px;
}

.day-content {
    font-size: 0.9em;
}

.duty {
    margin: 2px 0;
    padding: 2px 4px;
    border-radius: 3px;
    color: white;
    font-size: 0.85em;
}

.dienst {
    background-color: #e74c3c;
}

.rufdienst {
    background-color: #3498db;
}

.visite {
    background-color: #2ecc71;
}

.calendar-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.color-box {
    width: 20px;
    height: 20px;
    border-radius: 3px;
}

.nav-button {
    padding: 5px 15px;
    border: none;
    border-radius: 3px;
    background: #f5f5f5;
    cursor: pointer;
}

.action-button {
    padding: 5px 15px;
    border: none;
    border-radius: 3px;
    background: #3498db;
    color: white;
    cursor: pointer;
}

.empty {
    background: #f9f9f9;
}
</style>
{% endblock %}